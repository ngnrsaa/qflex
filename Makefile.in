TARGETS = qflex

CXX = @CXX@
CXXFLAGS = @CXXFLAGS@
PREFIX = @prefix@
PYBIND11 = @pybind11@
CIRQ = @cirq@
PYTEST = @pytest@
OPENMP = @openmp@

ifeq ($(CXX), icpc)
	CXXFLAGS += -mkl -DMKL_TENSOR -lpthread
else
  CXXFLAGS += -lgslcblas -lpthread
endif

ifeq ($(OPENMP), true)
  ifeq ($(CXX), icpc)
  	CXXFLAGS += -qopenmp
  else
    CXXFLAGS += -fopenmp
  endif
else
  CXXFLAGS += -Wno-unknown-pragmas
endif

ifeq ($(PYBIND11), true)
  TARGETS += pybind
endif

export CXX
export CXXFLAGS
export FLAGS

.PHONY: all
all: $(TARGETS)

.PHONY: qflex
qflex:
	git submodule update --init --recursive src/docopt
	$(MAKE) -C src/

.PHONY: pybind
pybind: qflex
	$(MAKE) -C src/ pybind

.PHONY: tests
tests:
	git submodule update --init --recursive tests/src/googletest
	$(MAKE) -C tests/src/

.PHONY: run-py-tests
run-py-tests: pybind
	$(MAKE) -C tests/python/ run-all

.PHONY: run-cxx-tests
run-cxx-tests: tests
	$(MAKE) -C tests/src/ run-all

TESTS = run-cxx-tests
ifeq ($(PYTEST), true)
  TESTS += run-py-tests
endif

.PHONY: run-tests
run-tests: $(TESTS)

.PHONY: install
install:
	@find config -type f -exec install -vD {} $(PREFIX)/share/qflex/{} \;
	@find docs -type f -exec install -vD {} $(PREFIX)/share/qflex/{} \;
	@install -vD src/qflex.x $(PREFIX)/bin/qflex
	@find python -type f -iname "*.so" -exec install -vD {} $(PREFIX)/lib/qflex/{} \;

.PHONY: clean
clean:
	-$(MAKE) -C src/ clean
	-$(MAKE) -C tests/src/ clean

.PHONY: clean-all
clean-all: clean
	-git submodule deinit --all
	-bash scripts/clean-git.sh -y
